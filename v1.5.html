<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Sticker Customizer - Shopify</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2563eb;
            --primary-dark: #1e40af;
            --primary-light: #dbeafe;
            --secondary-color: #f8fafc;
            --accent-color: #3b82f6;
            --gold-accent: #f59e0b;
            --border-color: #e2e8f0;
            --text-color: #1e293b;
            --light-text: #64748b;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }
        
        body {
            background-color: #f1f5f9;
            color: var(--text-color);
            line-height: 1.6;
            overflow-x: hidden;
            min-height: 100vh;
        }
        
        
        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            justify-content: space-between;
            padding: 1rem;
            background: white;
            box-shadow: var(--shadow-sm);
            margin-bottom: 1rem;
            border-radius: 0.5rem;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .progress-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            flex: 1;
        }
        
        .progress-step:not(:last-child)::after {
            content: '';
            position: absolute;
            top: 1rem;
            left: 50%;
            width: 100%;
            height: 2px;
            background: var(--border-color);
            z-index: 0;
        }
        
        .progress-step.active:not(:last-child)::after {
            background: var(--primary-color);
        }
        
        .progress-step-circle {
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            background: white;
            border: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.5rem;
            z-index: 1;
            transition: var(--transition);
        }
        
        .progress-step.active .progress-step-circle {
            background: var(--primary-color);
            border-color: var(--primary-color);
            color: white;
        }
        
        .progress-step.completed .progress-step-circle {
            background: var(--success-color);
            border-color: var(--success-color);
            color: white;
        }
        
        .progress-step-label {
            font-size: 0.75rem;
            text-align: center;
            color: var(--light-text);
            font-weight: 500;
        }
        
        .progress-step.active .progress-step-label {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .progress-step.completed .progress-step-label {
            color: var(--success-color);
        }
        
        /* Main Container */
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem;
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 1rem;
            min-height: calc(100vh - 80px);
        }
        
        /* Controls Panel */
        .controls-panel {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 1rem;
            height: calc(100vh - 80px);
        }
        
        .controls-tabs {
            display: flex;
            background: var(--secondary-color);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        .controls-tab {
            flex: 1;
            padding: 1rem 0.5rem;
            text-align: center;
            font-weight: 500;
            color: var(--light-text);
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 3px solid transparent;
            font-size: 0.875rem;
        }
        
        .controls-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: white;
        }
        
        .controls-tab i {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 1rem;
        }
        
        .controls-content {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
            overflow-x: hidden;
            scrollbar-width: thin;
            scrollbar-color: var(--border-color) transparent;
        }
        
        .controls-content::-webkit-scrollbar {
            width: 4px;
        }
        
        .controls-content::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .controls-content::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 2px;
        }
        
        .controls-content::-webkit-scrollbar-thumb:hover {
            background-color: var(--light-text);
        }
        
        /* Mobile-specific scrollbar styling */
        @media (max-width: 575px) {
            .controls-content::-webkit-scrollbar {
                width: 3px;
            }
        }
        
        .control-section {
            margin-bottom: 1.5rem;
        }
        
        .control-section:last-child {
            margin-bottom: 0;
        }
        
        .control-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .control-section-title i {
            color: var(--primary-color);
            font-size: 0.875rem;
        }
        
        .help-tooltip {
            position: relative;
            display: inline-block;
            margin-left: 0.25rem;
            color: var(--light-text);
            cursor: help;
        }
        
        .help-tooltip i {
            font-size: 0.75rem;
        }
        
        .help-tooltip .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--text-color);
            color: white;
            text-align: center;
            border-radius: 0.5rem;
            padding: 0.5rem;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.75rem;
            line-height: 1.4;
        }
        
        .help-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Hidden utility class */
        .hidden {
            display: none !important;
        }
        
        /* Logo Upload */
        .logo-upload-container {
            border: 2px dashed var(--border-color);
            border-radius: 0.75rem;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            background: var(--secondary-color);
            position: relative;
        }
        
        .logo-upload-container:hover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }
        
        .logo-upload-container.dragover {
            border-color: var(--primary-color);
            background: var(--primary-light);
        }
        
        .logo-upload-icon {
            font-size: 1.5rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }
        
        .logo-upload-text {
            font-weight: 500;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }
        
        .logo-upload-subtext {
            font-size: 0.75rem;
            color: var(--light-text);
        }
        
        .logo-preview {
            margin-top: 0.75rem;
            display: none;
        }
        
        .logo-preview-img {
            max-width: 100%;
            max-height: 100px;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-md);
        }
        
        .logo-preview-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
        }
        
        .logo-preview-name {
            font-size: 0.75rem;
            color: var(--light-text);
            font-weight: 500;
            word-break: break-all;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            padding-right: 0.5rem;
        }
        
        .logo-preview-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .logo-remove-bg-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 500;
        }
        
        .logo-remove-bg-btn:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .logo-remove-bg-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }
        
        .logo-remove-bg-btn.processing {
            background: var(--warning-color);
            cursor: wait;
        }
        
        .logo-remove-bg-btn.processing:hover {
            background: #d97706;
        }
        
        .logo-remove-btn {
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.375rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .logo-remove-btn:hover {
            background: #dc2626;
        }
        
        /* Outline Controls */
        .outline-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            padding: 0.75rem;
            background: var(--secondary-color);
            border-radius: 0.5rem;
        }
        
        .outline-toggle-label {
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #cbd5e1;
            transition: var(--transition);
            border-radius: 24px;
        }
        
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: var(--transition);
            border-radius: 50%;
        }
        
        input:checked + .toggle-slider {
            background-color: var(--primary-color);
        }
        
        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }
        
        .outline-controls {
            padding: 0.75rem;
            background: var(--secondary-color);
            border-radius: 0.5rem;
        }
        
        .outline-controls.hidden {
            display: none;
        }
        
        .slider-control {
            margin-bottom: 0.75rem;
        }
        
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .slider-value {
            color: var(--primary-color);
            font-weight: 600;
        }
        
        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e2e8f0;
            outline: none;
            -webkit-appearance: none;
        }
        
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }
        
        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: var(--shadow-md);
        }
        
        .color-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
        }
        
        .color-picker {
            width: 48px;
            height: 36px;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            cursor: pointer;
            flex-shrink: 0;
            background: none;
            padding: 0;
            transition: var(--transition);
        }
        
        .color-picker:hover {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .color-picker::-webkit-color-swatch-wrapper {
            padding: 0;
            border: none;
            border-radius: 0.25rem;
        }
        
        .color-picker::-webkit-color-swatch {
            border: none;
            border-radius: 0.25rem;
        }
        
        .color-picker::-moz-color-swatch {
            border: none;
            border-radius: 0.25rem;
        }
        
        /* Mobile optimizations for color picker */
        @media (max-width: 575px) {
            .color-picker {
                width: 44px;
                height: 32px;
            }
        }
        
        @media (max-width: 375px) {
            .color-picker {
                width: 40px;
                height: 30px;
            }
        }
        
        .color-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
        }
        

        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            padding: 0.5rem;
            background: white;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
        }
        
        .checkbox-control input {
            margin: 0;
        }
        
        .checkbox-label {
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        /* Grid Controls */
        .grid-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
        }
        
        .grid-control {
            padding: 0.75rem;
            background: var(--secondary-color);
            border-radius: 0.5rem;
        }
        
        .grid-control-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .grid-control-inputs {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .grid-control-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.75rem;
        }
        
        .grid-control-btn:hover {
            background: var(--primary-dark);
        }
        
        .grid-control-btn:disabled {
            background: #cbd5e1;
            cursor: not-allowed;
        }
        
        .grid-control-value {
            min-width: 30px;
            text-align: center;
            font-weight: 600;
            font-size: 1rem;
        }
        
        /* Board and Sticker Size Controls */
        .size-controls {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }
        
        .size-control {
            flex: 1;
            padding: 0.75rem;
            background: var(--secondary-color);
            border-radius: 0.5rem;
        }
        
        .size-control-label {
            font-weight: 500;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .size-control-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background: white;
        }
        
        .size-control-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
        }
        
        .number-input-container {
            display: flex;
            align-items: center;
        }
        
        .number-input-btn {
            width: 28px;
            height: 28px;
            border-radius: 0.25rem;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.75rem;
        }
        
        .number-input-btn:hover {
            background: var(--secondary-color);
        }
        
        .number-input-btn:disabled {
            background: #f1f5f9;
            color: #cbd5e1;
            cursor: not-allowed;
        }
        
        .number-input {
            flex: 1;
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0;
            font-size: 0.875rem;
            text-align: center;
            border-left: none;
            border-right: none;
        }
        
        .number-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .number-input-container .number-input-btn:first-child {
            border-radius: 0.25rem 0 0 0.25rem;
        }
        
        .number-input-container .number-input-btn:last-child {
            border-radius: 0 0.25rem 0.25rem 0;
        }
        
        /* Smart Suggestions */
        .smart-suggestions {
            margin-top: 0.75rem;
            padding: 0.75rem;
            background: var(--primary-light);
            border-radius: 0.5rem;
            border-left: 3px solid var(--primary-color);
        }
        
        .smart-suggestions-title {
            font-weight: 600;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .smart-suggestion-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem;
            background: white;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .smart-suggestion-item:hover {
            background: var(--secondary-color);
        }
        
        .smart-suggestion-item:last-child {
            margin-bottom: 0;
        }
        
        .smart-suggestion-text {
            font-size: 0.875rem;
        }
        
        .smart-suggestion-apply {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .smart-suggestion-apply:hover {
            background: var(--primary-dark);
        }
        
        /* Preview Panel */
        .preview-panel {
            background: white;
            border-radius: 1rem;
            box-shadow: var(--shadow-md);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .preview-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        
        .preview-title {
            font-size: 1.125rem;
            font-weight: 600;
        }
        
        .preview-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .preview-action-btn {
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            background: white;
            color: var(--text-color);
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .preview-action-btn:hover {
            background: var(--secondary-color);
        }
        
        .preview-action-btn.primary {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }
        
        .preview-action-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .preview-content {
            padding: 1rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }
        
        .preview-board-container {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--secondary-color);
            border-radius: 0.75rem;
            padding: 1rem;
            position: relative;
            overflow: auto;
            min-height: 250px;
        }
        
        .preview-board {
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .preview-board-label {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            background: rgba(255, 255, 255, 0.9);
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 500;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }
        
        .canvas-container {
            background-image: 
                linear-gradient(45deg, #ccc 25%, transparent 25%), 
                linear-gradient(-45deg, #ccc 25%, transparent 25%), 
                linear-gradient(45deg, transparent 75%, #ccc 75%), 
                linear-gradient(-45deg, transparent 75%, #ccc 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
            background-color: #fff;
            border-radius: 0.5rem;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        #stickerCanvas {
            object-fit: contain;
            display: block;
            transition: var(--transition);
        }
        
        .preview-specs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }
        
        .preview-spec {
            background: var(--secondary-color);
            padding: 0.75rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        
        .preview-spec-title {
            font-size: 0.75rem;
            color: var(--light-text);
            margin-bottom: 0.25rem;
        }
        
        .preview-spec-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        /* Confirmation Section */
        .confirmation-section {
            padding: 1rem;
            border-top: 1px solid var(--border-color);
            background: var(--secondary-color);
        }
        
        .confirmation-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .confirmation-text {
            color: var(--light-text);
            margin-bottom: 0.75rem;
            font-size: 0.875rem;
        }
        
        .confirmation-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .confirmation-btn {
            flex: 1;
            padding: 0.75rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }
        
        .confirmation-btn.primary {
            background: var(--primary-color);
            color: white;
            border: none;
        }
        
        .confirmation-btn.primary:hover {
            background: var(--primary-dark);
        }
        
        .confirmation-btn.secondary {
            background: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }
        
        .confirmation-btn.secondary:hover {
            background: var(--secondary-color);
        }
        
        .confirmation-message {
            display: none;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-top: 0.75rem;
            text-align: center;
            font-weight: 500;
            font-size: 0.875rem;
        }
        
        .confirmation-message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.3);
        }
        
        .confirmation-message.help {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(245, 158, 11, 0.3);
        }
        
        /* Mobile Menu Overlay - Removed for direct mobile display */
        .controls-panel-overlay {
            display: none;
        }
        
        /* Notification Toast */
        .notification-toast {
            position: fixed;
            bottom: 1rem;
            right: 1rem;
            background: white;
            border-radius: 0.5rem;
            box-shadow: var(--shadow-lg);
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateX(120%);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
        }
        
        .notification-toast.show {
            transform: translateX(0);
        }
        
        .notification-toast-icon {
            font-size: 1.25rem;
        }
        
        .notification-toast.success .notification-toast-icon {
            color: var(--success-color);
        }
        
        .notification-toast.error .notification-toast-icon {
            color: var(--danger-color);
        }
        
        .notification-toast.info .notification-toast-icon {
            color: var(--primary-color);
        }
        
        .notification-toast-content {
            flex: 1;
        }
        
        .notification-toast-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .notification-toast-message {
            font-size: 0.875rem;
            color: var(--light-text);
        }
        
        .notification-toast-close {
            background: none;
            border: none;
            color: var(--light-text);
            cursor: pointer;
            font-size: 1rem;
        }
        
        /* =========================================== */
        /* MOBILE LAYOUT - Controls FIRST, then preview */
        /* =========================================== */
        
        /* Tablet (768px - 1023px) - Controls on side */
        @media (min-width: 768px) and (max-width: 1023px) {
            .app-container {
                grid-template-columns: 280px 1fr;
                padding: 0.5rem;
                gap: 0.75rem;
            }
            
            .controls-panel {
                width: 280px;
                height: calc(100vh - 60px);
                top: 0.5rem;
            }
            
            .preview-specs {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }
            
            .size-controls {
                flex-direction: column;
                gap: 0.5rem;
            }
        }
        
        /* Mobile (up to 767px) - Controls FIRST, then preview BELOW */
        @media (max-width: 767px) {
            .app-container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto;
                gap: 1rem;
                padding: 1rem;
                min-height: auto;
            }
            
            /* Controls panel comes FIRST on mobile */
            .controls-panel {
                position: relative;
                top: auto;
                left: auto;
                width: auto;
                height: auto;
                max-height: 450px;
                order: 1; /* Controls come first */
                margin-bottom: 0;
                border-radius: 1rem;
                box-shadow: var(--shadow-md);
            }
            
            /* Preview panel comes SECOND on mobile */
            .preview-panel {
                order: 2; /* Preview comes second */
                margin-top: 0;
            }
            
            .controls-content {
                max-height: 350px;
                overflow-y: auto;
                padding: 1rem;
            }
            
            .control-section {
                margin-bottom: 1.25rem;
            }
            
            .preview-board-container {
                min-height: 300px;
            }
            
            /* Progress indicator adjustments */
            .progress-indicator {
                margin-bottom: 0.75rem;
                padding: 0.75rem;
            }
            
            .progress-step-circle {
                width: 1.75rem;
                height: 1.75rem;
                font-size: 0.75rem;
            }
            
            .progress-step-label {
                font-size: 0.7rem;
            }
        }
        
        /* Enhanced Mobile (up to 575px) */
        @media (max-width: 575px) {
            .app-container {
                padding: 0.75rem;
                gap: 0.75rem;
            }
            
            .controls-panel {
                max-height: 400px;
            }
            
            .controls-content {
                max-height: 320px;
                padding: 0.75rem;
            }
            
            .control-section {
                margin-bottom: 1rem;
            }
            
            .control-section-title {
                font-size: 0.9rem;
            }
            
            .logo-upload-container {
                padding: 1rem 0.75rem;
            }
            
            .logo-upload-text {
                font-size: 0.9rem;
            }
            
            .logo-upload-subtext {
                font-size: 0.8rem;
            }
            
            .size-controls {
                flex-direction: column;
                gap: 0.75rem;
            }
            
            .size-control {
                padding: 0.75rem;
            }
            
            .preview-board-container {
                min-height: 280px;
            }
            
            .preview-specs {
                grid-template-columns: repeat(2, 1fr);
                gap: 0.75rem;
                margin-top: 0.75rem;
            }
            
            .preview-spec {
                padding: 0.75rem;
            }
            
            .confirmation-actions {
                flex-direction: column;
                gap: 0.5rem;
            }
            
            .confirmation-btn {
                padding: 0.875rem;
            }
        }
        
        /* Small Mobile (up to 375px) */
        @media (max-width: 375px) {
            .app-container {
                padding: 0.5rem;
                gap: 0.5rem;
            }
            
            .controls-panel {
                max-height: 380px;
            }
            
            .controls-content {
                max-height: 300px;
                padding: 0.5rem;
            }
            
            .preview-board-container {
                min-height: 250px;
            }
            
            .preview-specs {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }
            
            .control-section-title {
                font-size: 0.85rem;
            }
            
            .logo-upload-container {
                padding: 0.875rem 0.5rem;
            }
        }
        
        /* Height-based adjustments for desktop */
        @media (min-width: 1024px) and (max-height: 800px) {
            .controls-panel {
                height: calc(100vh - 60px);
                top: 0.5rem;
            }
            
            .controls-content {
                max-height: calc(100vh - 100px);
            }
            
            .progress-indicator {
                padding: 0.75rem 1rem;
            }
        }
        
        @media (min-width: 1024px) and (min-height: 801px) and (max-height: 1000px) {
            .controls-panel {
                height: calc(100vh - 80px);
                top: 1rem;
            }
            
            .controls-content {
                max-height: calc(100vh - 120px);
            }
        }
        
        @media (min-width: 1024px) and (min-height: 1001px) {
            .controls-panel {
                height: calc(100vh - 80px);
                top: 1rem;
            }
            
            .controls-content {
                max-height: calc(100vh - 120px);
            }
        }
        
        /* Touch device optimizations */
        @media (hover: none) and (pointer: coarse) {
            .controls-tab {
                padding: 1rem 0.5rem;
            }
            
            .preview-action-btn,
            .confirmation-btn {
                min-height: 44px;
                touch-action: manipulation;
            }
            
            .number-input-btn {
                min-width: 44px;
                min-height: 44px;
            }
            
            .slider {
                height: 8px;
            }
            
            .slider::-webkit-slider-thumb {
                width: 24px;
                height: 24px;
            }
            
            /* Enhanced mobile touch scrolling for controls */
            .controls-content {
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
            }
            
            .control-section {
                margin-bottom: 1.25rem;
            }
        }
        
        /* High DPI display optimizations */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
            .preview-board {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
            
            .controls-panel {
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            }
        }
    </style>
</head>
<body>
    <!-- Progress Indicator -->
    <div class="progress-indicator">
        <div class="progress-step active" id="step1">
            <div class="progress-step-circle">
                <i class="fas fa-image"></i>
            </div>
            <div class="progress-step-label">Logo</div>
        </div>
        <div class="progress-step" id="step2">
            <div class="progress-step-circle">
                <i class="fas fa-border-style"></i>
            </div>
            <div class="progress-step-label">Outline</div>
        </div>
        <div class="progress-step" id="step3">
            <div class="progress-step-circle">
                <i class="fas fa-th"></i>
            </div>
            <div class="progress-step-label">Layout</div>
        </div>
        <div class="progress-step" id="step4">
            <div class="progress-step-circle">
                <i class="fas fa-check"></i>
            </div>
            <div class="progress-step-label">Confirm</div>
        </div>
    </div>
    
    <!-- Main App Container -->
    <div class="app-container">
        <!-- Controls Panel (FIRST on mobile, Left on desktop) -->
        <aside class="controls-panel" id="controlsPanel">
            <div class="controls-tabs">
                <div class="controls-tab active" data-tab="design">
                    <i class="fas fa-palette"></i>
                    <span>Design</span>
                </div>
            </div>
            
            <div class="controls-content">
                <!-- Design Tab -->
                <div class="tab-content" id="designTab">
                    <!-- Logo Upload Section -->
                    <div class="control-section" id="logoSection">
                        <div class="control-section-title">
                            <i class="fas fa-image"></i>
                            Logo
                            <div class="help-tooltip">
                                <i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">Upload your logo in PNG or JPG format. Recommended size: 500x500px or larger for best quality. Use 'Remove BG' for automatic background removal.</span>
                            </div>
                        </div>
                        <div class="logo-upload-container" id="logoUploadContainer">
                            <div class="logo-upload-icon">
                                <i class="fas fa-cloud-upload-alt"></i>
                            </div>
                            <div class="logo-upload-text">Upload Logo</div>
                            <div class="logo-upload-subtext">Click to upload or drag and drop</div>
                            <input type="file" id="logoFileInput" accept="image/*" style="display: none;">
                        </div>
                        <div class="logo-preview" id="logoPreview">
                            <img class="logo-preview-img" id="logoPreviewImg" src="" alt="Logo Preview">
                            <div class="logo-preview-actions">
                                <div class="logo-preview-name" id="logoPreviewName"></div>
                                <div class="logo-preview-controls">
                                    <button class="logo-remove-bg-btn" id="logoRemoveBgBtn" title="Remove Background">
                                        <i class="fas fa-cut"></i>
                                        <span>Remove BG</span>
                                    </button>
                                    <button class="logo-remove-btn" id="logoRemoveBtn">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Color Controls -->
                    <div class="control-section" id="colorSection">
                        <div class="control-section-title">
                            <i class="fas fa-palette"></i>
                            Colors
                            <div class="help-tooltip">
                                <i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">Choose outline colors for your stickers. Use the palette or enter a custom hex color.</span>
                            </div>
                        </div>
                        
                        <div class="color-control">
                            <input type="color" class="color-picker" id="outlineColorPicker" value="#000000">
                            <input type="text" class="color-input" id="outlineColorHex" value="#000000" maxlength="7">
                        </div>
                    </div>

                    <!-- Size Controls -->
                    <div class="control-section" id="sizeSection">
                        <div class="control-section-title">
                            <i class="fas fa-ruler-combined"></i>
                            Size Settings
                            <div class="help-tooltip">
                                <i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">Select your board size and sticker diameter. Layout will automatically optimize for perfect fit.</span>
                            </div>
                        </div>
                        
                        <div class="size-controls">
                            <div class="size-control">
                                <div class="size-control-label">
                                    <i class="fas fa-expand-arrows-alt"></i>
                                    Board Size (cm)
                                </div>
                                <select class="size-control-input" id="boardSizeSelect">
                                    <option value="10x15">10 × 15</option>
                                    <option value="15x20">15 × 20</option>
                                    <option value="20x30">20 × 30</option>
                                    <option value="30x40">30 × 40</option>
                                    <option value="40x50">40 × 50</option>
                                    <option value="50x70">50 × 70</option>
                                </select>
                            </div>
                            
                            <div class="size-control">
                                <div class="size-control-label">
                                    <i class="fas fa-circle"></i>
                                    Sticker Diameter (cm)
                                </div>
                                <div class="number-input-container">
                                    <button class="number-input-btn" id="diameterDecrease">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="number" class="number-input" id="diameterInput" value="5" min="1" max="20" step="0.5">
                                    <button class="number-input-btn" id="diameterIncrease">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Outline Controls -->
                    <div class="control-section" id="outlineSection">
                        <div class="control-section-title">
                            <i class="fas fa-border-style"></i>
                            Outline Settings
                            <div class="help-tooltip">
                                <i class="fas fa-question-circle"></i>
                                <span class="tooltip-text">Configure outline width and smoothing for your stickers.</span>
                            </div>
                        </div>
                        
                        <div class="outline-toggle-container">
                            <div class="outline-toggle-label">Enable Outline</div>
                            <label class="toggle-switch">
                                <input type="checkbox" id="outlineToggle" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                        
                        <div class="outline-controls" id="outlineControls">
                            <div class="slider-control">
                                <div class="slider-label">
                                    <span>Outline Width</span>
                                    <span class="slider-value" id="outlineWidthValue">6px</span>
                                </div>
                                <input type="range" min="0" max="30" value="6" class="slider" id="outlineWidth">
                            </div>
                            
                            <div class="checkbox-control">
                                <input type="checkbox" id="smoothingToggle" checked>
                                <label class="checkbox-label" for="smoothingToggle">Enable Smooth Edges</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
        
        <!-- Preview Panel (SECOND on mobile, Right on desktop) -->
        <main class="preview-panel">
            <div class="preview-header">
                <h2 class="preview-title">Preview</h2>
                <div class="preview-actions">
                    <button class="preview-action-btn" id="resetBtn">
                        <i class="fas fa-undo"></i>
                        <span>Reset</span>
                    </button>
                    <button class="preview-action-btn primary" id="downloadBtn">
                        <i class="fas fa-download"></i>
                        <span>Download</span>
                    </button>
                </div>
            </div>
            
            <div class="preview-content">
                <div class="preview-board-container">
                    <div class="preview-board" id="previewBoard">
                        <div class="preview-board-label" id="boardLabel">Board 10 × 15 cm</div>
                        <div class="canvas-container" id="canvasContainer">
                            <canvas id="stickerCanvas"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="preview-specs">
                    <div class="preview-spec">
                        <div class="preview-spec-title">Board Size</div>
                        <div class="preview-spec-value" id="boardSizeValue">15 × 20 cm</div>
                    </div>
                    <div class="preview-spec">
                        <div class="preview-spec-title">Total Stickers</div>
                        <div class="preview-spec-value" id="totalStickersValue">4</div>
                    </div>
                    <div class="preview-spec">
                        <div class="preview-spec-title">Sticker Diameter</div>
                        <div class="preview-spec-value" id="stickerDiameterValue">5 cm</div>
                    </div>
                    <div class="preview-spec">
                        <div class="preview-spec-title">Space Used</div>
                        <div class="preview-spec-value" id="spaceUsedValue">75%</div>
                    </div>
                </div>
            </div>
            
            <div class="confirmation-section">
                <h3 class="confirmation-title">Do these labels suit you?</h3>
                <p class="confirmation-text">Check preview and confirm if design meets your expectations.</p>
                
                <div class="confirmation-actions">
                    <button class="confirmation-btn primary" id="confirmYesBtn">
                        <i class="fas fa-check-circle"></i>
                        <span>Yes, it's perfect!</span>
                    </button>
                    <button class="confirmation-btn secondary" id="confirmHelpBtn">
                        <i class="fas fa-question-circle"></i>
                        <span>I need help</span>
                    </button>
                </div>
                
                <div class="confirmation-message success" id="successMessage">
                    <i class="fas fa-check"></i> Thank you! Your design has been confirmed and added to your cart.
                </div>
                
                <div class="confirmation-message help" id="helpMessage">
                    <i class="fas fa-headset"></i> Our support team will contact you shortly to assist with your design.
                </div>
            </div>
        </main>
    </div>
    
    <!-- Notification Toast -->
    <div class="notification-toast" id="notificationToast">
        <div class="notification-toast-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <div class="notification-toast-content">
            <div class="notification-toast-title" id="notificationTitle">Success</div>
            <div class="notification-toast-message" id="notificationMessage">Action completed successfully</div>
        </div>
        <button class="notification-toast-close" id="notificationClose">
            <i class="fas fa-times"></i>
        </button>
    </div>
    
    <script>
        // Configuration - Replace with your Remove.bg API key
        const REMOVE_BG_API_KEY = '39nH2XMTcoAxnogxmqVBuAXH';
        
        // Validate API key configuration
        if (REMOVE_BG_API_KEY === 'YOUR_REMOVE_BG_API_KEY_HERE') {
            console.warn('Remove.bg API key not configured. Background removal will not work.');
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // DOM Elements
            const controlsPanel = document.getElementById('controlsPanel');
            
            // Tab Elements
            const designTab = document.getElementById('designTab');
            
            // Progress Steps
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            const step4 = document.getElementById('step4');
            
            // Logo Upload Elements
            const logoSection = document.getElementById('logoSection');
            const logoUploadContainer = document.getElementById('logoUploadContainer');
            const logoFileInput = document.getElementById('logoFileInput');
            const logoPreview = document.getElementById('logoPreview');
            const logoPreviewImg = document.getElementById('logoPreviewImg');
            const logoPreviewName = document.getElementById('logoPreviewName');
            const logoRemoveBtn = document.getElementById('logoRemoveBtn');
            const logoRemoveBgBtn = document.getElementById('logoRemoveBgBtn');
            
            // Outline Elements
            const outlineSection = document.getElementById('outlineSection');
            const outlineToggle = document.getElementById('outlineToggle');
            const outlineControls = document.getElementById('outlineControls');
            const outlineWidth = document.getElementById('outlineWidth');
            const outlineWidthValue = document.getElementById('outlineWidthValue');
            const outlineColorPicker = document.getElementById('outlineColorPicker');
            const outlineColorHex = document.getElementById('outlineColorHex');
            const smoothingToggle = document.getElementById('smoothingToggle');
            
            // Canvas and Container Elements
            const canvas = document.getElementById('stickerCanvas');
            const ctx = canvas.getContext('2d');
            const previewBoard = document.getElementById('previewBoard');
            const canvasContainer = document.getElementById('canvasContainer');
            
            // Size Elements
            const sizeSection = document.getElementById('sizeSection');
            const boardSizeSelect = document.getElementById('boardSizeSelect');
            const diameterDecrease = document.getElementById('diameterDecrease');
            const diameterIncrease = document.getElementById('diameterIncrease');
            const diameterInput = document.getElementById('diameterInput');
            
            // Preview Elements
            const boardLabel = document.getElementById('boardLabel');
            const boardSizeValue = document.getElementById('boardSizeValue');
            const totalStickersValue = document.getElementById('totalStickersValue');
            const stickerDiameterValue = document.getElementById('stickerDiameterValue');
            const spaceUsedValue = document.getElementById('spaceUsedValue');
            
            // Action Buttons
            const resetBtn = document.getElementById('resetBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const confirmYesBtn = document.getElementById('confirmYesBtn');
            const confirmHelpBtn = document.getElementById('confirmHelpBtn');
            const successMessage = document.getElementById('successMessage');
            const helpMessage = document.getElementById('helpMessage');
            
            // Notification Toast
            const notificationToast = document.getElementById('notificationToast');
            const notificationTitle = document.getElementById('notificationTitle');
            const notificationMessage = document.getElementById('notificationMessage');
            const notificationClose = document.getElementById('notificationClose');
            
            // Default logo
            const defaultLogo = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%232563eb'/%3E%3Ctext x='50' y='60' font-family='Inter, sans-serif' font-size='24' text-anchor='middle' fill='white'%3ELogo%3C/text%3E%3C/svg%3E";
            

            // Board size options mapping
            const boardSizeOptions = {
                '10x15': { width: 10, height: 15 },
                '15x20': { width: 15, height: 20 },
                '20x30': { width: 20, height: 30 },
                '30x40': { width: 30, height: 40 },
                '40x50': { width: 40, height: 50 },
                '50x70': { width: 50, height: 70 }
            };
            
            // App State
            const appState = {
                logoUrl: defaultLogo,
                originalImage: null,
                boardSize: { width: 15, height: 20 }, // in cm
                stickerDiameter: 5, // in cm
                outlineEnabled: true,
                outline: {
                    width: 6,
                    color: '#000000',
                    smoothing: true
                },
                grid: {
                    horizontal: 2,
                    vertical: 2
                },
                currentStep: 1,
                hasLogo: false,
                hasOutline: true,
                hasLayout: false,
                backgroundRemoved: false,
                isProcessingBgRemoval: false
            };
            
            // Test Remove.bg API key on page load
            async function testRemoveBgApi() {
                try {
                    console.log('Testing Remove.bg API key...');
                    
                    // Create a simple test image (1x1 pixel PNG)
                    const testCanvas = document.createElement('canvas');
                    testCanvas.width = 1;
                    testCanvas.height = 1;
                    const testCtx = testCanvas.getContext('2d');
                    testCtx.fillStyle = '#000000';
                    testCtx.fillRect(0, 0, 1, 1);
                    
                    const testBlob = await new Promise(resolve => {
                        testCanvas.toBlob(resolve, 'image/png');
                    });
                    
                    const testFormData = new FormData();
                    testFormData.append('image_file', testBlob, 'test.png');
                    testFormData.append('size', 'auto');
                    
                    const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                        method: 'POST',
                        headers: {
                            'X-Api-Key': REMOVE_BG_API_KEY
                        },
                        body: testFormData
                    });
                    
                    if (response.ok) {
                        console.log('Remove.bg API key is valid');
                    } else {
                        console.warn('Remove.bg API key test failed:', response.status);
                    }
                } catch (error) {
                    console.warn('Remove.bg API key test error:', error.message);
                }
            }
            
            // Initialize the app
            function initApp() {
                // Test API key in background
                testRemoveBgApi();
                
                // Set initial values
                outlineWidth.value = 6;
                outlineWidthValue.textContent = `6px`;
                outlineToggle.checked = appState.outlineEnabled;
                smoothingToggle.checked = appState.outline.smoothing;
                boardSizeSelect.value = '15x20';
                diameterInput.value = appState.stickerDiameter;
                
                // Set initial color picker value
                outlineColorPicker.value = appState.outline.color;
                outlineColorHex.value = appState.outline.color;
                
                // Show default logo preview
                logoPreviewImg.src = defaultLogo;
                logoPreviewName.textContent = 'Default Logo';
                logoPreview.style.display = 'block';
                
                // Load default logo
                loadDefaultLogo();
                
                // Auto-optimize layout based on current settings
                autoOptimizeLayout();
                
                // Update size display
                updateSizeDisplay();
                
                // Update space used
                updateSpaceUsed();
                
                // Update progress
                updateProgress();
                
                // Test layout calculations
                testLayoutCalculation();
                
                // Initial draw
                draw();
            }
            
            // Load default logo as image
            function loadDefaultLogo() {
                const img = new Image();
                img.onload = function() {
                    appState.originalImage = img;
                    draw();
                };
                img.src = defaultLogo;
            }
            
            // Show notification toast
            function showNotification(title, message, type = 'success') {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                
                // Update icon and class based on type
                const icon = notificationToast.querySelector('.notification-toast-icon i');
                notificationToast.className = 'notification-toast show ' + type;
                
                if (type === 'success') {
                    icon.className = 'fas fa-check-circle';
                } else if (type === 'error') {
                    icon.className = 'fas fa-exclamation-circle';
                } else if (type === 'info') {
                    icon.className = 'fas fa-info-circle';
                }
                
                // Auto hide after 5 seconds
                setTimeout(() => {
                    notificationToast.classList.remove('show');
                }, 5000);
            }
            
            // Update progress indicator
            function updateProgress() {
                // Reset all steps
                step1.classList.remove('active', 'completed');
                step2.classList.remove('active', 'completed');
                step3.classList.remove('active', 'completed');
                step4.classList.remove('active', 'completed');
                
                // Update based on current state
                if (appState.hasLogo) {
                    step1.classList.add('completed');
                    step2.classList.add('active');
                    
                    if (appState.hasOutline) {
                        step2.classList.add('completed');
                        step3.classList.add('active');
                        
                        if (appState.hasLayout) {
                            step3.classList.add('completed');
                            step4.classList.add('active');
                        }
                    }
                } else {
                    step1.classList.add('active');
                }
            }
            
            // Mobile Menu Toggle - Removed for direct mobile display
            
            // Removed tab switching functionality since all controls are now in Design tab
            
            // Logo Upload with drag and drop
            logoUploadContainer.addEventListener('click', function() {
                logoFileInput.click();
            });
            
            // Prevent default drag behaviors
            const dragEvents = ['dragenter', 'dragover', 'dragleave', 'drop'];
            const preventDefaults = (e) => {
                e.preventDefault();
                e.stopPropagation();
            };
            
            dragEvents.forEach(eventName => {
                logoUploadContainer.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });
            
            const highlight = () => {
                logoUploadContainer.classList.add('dragover');
            };
            
            const unhighlight = () => {
                logoUploadContainer.classList.remove('dragover');
            };
            
            // Highlight drop area when item is dragged over it
            logoUploadContainer.addEventListener('dragenter', highlight, false);
            logoUploadContainer.addEventListener('dragover', highlight, false);
            logoUploadContainer.addEventListener('dragleave', unhighlight, false);
            logoUploadContainer.addEventListener('drop', unhighlight, false);
            
            // Handle dropped files
            logoUploadContainer.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                
                if (files.length > 0) {
                    handleFiles(files);
                }
            }
            
            logoFileInput.addEventListener('change', function(event) {
                const files = event.target.files;
                if (files.length > 0) {
                    handleFiles(files);
                }
            });
            
            function handleFiles(files) {
                const file = files[0];
                if (file) {
                    if (file.type.match('image.*')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(e) {
                            // Update logo URL
                            appState.logoUrl = e.target.result;
                            appState.hasLogo = true;
                            appState.backgroundRemoved = false;
                            appState.isProcessingBgRemoval = false;
                            
                            // Reset button state
                            logoRemoveBgBtn.disabled = false;
                            logoRemoveBgBtn.classList.remove('processing');
                            logoRemoveBgBtn.innerHTML = '<i class="fas fa-cut"></i><span>Remove BG</span>';
                            logoRemoveBgBtn.title = 'Remove Background';
                            
                            // Show preview
                            logoPreviewImg.src = e.target.result;
                            logoPreviewName.textContent = file.name;
                            logoPreview.style.display = 'block';
                            
                            // Load image for canvas
                            const img = new Image();
                            img.onload = function() {
                                appState.originalImage = img;
                                draw();
                                updateProgress();
                            };
                            img.src = e.target.result;
                            
                            // Show notification
                            showNotification('Logo Uploaded', 'Your logo has been successfully uploaded', 'success');
                        };
                        
                        reader.readAsDataURL(file);
                    } else {
                        showNotification('Upload Error', 'Please select an image file (JPEG, PNG, GIF, etc.)', 'error');
                    }
                }
            }
            
            // Remove logo
            logoRemoveBtn.addEventListener('click', function() {
                // Reset to default logo
                appState.logoUrl = defaultLogo;
                appState.hasLogo = false;
                appState.backgroundRemoved = false;
                appState.isProcessingBgRemoval = false;
                
                // Update preview
                logoPreviewImg.src = defaultLogo;
                logoPreviewName.textContent = 'Default Logo';
                
                // Load default logo
                loadDefaultLogo();
                
                // Update progress
                updateProgress();
                
                // Reset button state
                logoRemoveBgBtn.disabled = false;
                logoRemoveBgBtn.innerHTML = '<i class="fas fa-cut"></i><span>Remove BG</span>';
                
                // Show notification
                showNotification('Logo Removed', 'Your logo has been removed', 'info');
            });
            
            // Background Removal with Retry Logic
            logoRemoveBgBtn.addEventListener('click', async function() {
                if (appState.isProcessingBgRemoval || !appState.originalImage) {
                    return;
                }
                
                appState.isProcessingBgRemoval = true;
                
                // Update button state
                this.disabled = true;
                this.classList.add('processing');
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Processing...</span>';
                
                const maxRetries = 2;
                let retryCount = 0;
                
                const attemptBackgroundRemoval = async () => {
                    try {
                        showNotification('Processing', 'Removing background, please wait...', 'info');
                        
                        // Validate image before processing
                        if (!appState.originalImage.complete || appState.originalImage.naturalWidth === 0) {
                            throw new Error('Invalid image data');
                        }
                        
                        // Check minimum image size for better results
                        if (appState.originalImage.naturalWidth < 100 || appState.originalImage.naturalHeight < 100) {
                            throw new Error('Image too small. Please use an image at least 100x100 pixels.');
                        }
                        
                        // Create a separate canvas for image processing (not the preview canvas)
                        const processingCanvas = document.createElement('canvas');
                        const processingCtx = processingCanvas.getContext('2d');
                        
                        // Set canvas size to image dimensions
                        processingCanvas.width = appState.originalImage.naturalWidth;
                        processingCanvas.height = appState.originalImage.naturalHeight;
                        
                        // Clear canvas and draw the image
                        processingCtx.clearRect(0, 0, processingCanvas.width, processingCanvas.height);
                        processingCtx.drawImage(appState.originalImage, 0, 0);
                        
                        // Convert to blob with high quality
                        const blob = await new Promise((resolve, reject) => {
                            processingCanvas.toBlob((blob) => {
                                if (blob) {
                                    resolve(blob);
                                } else {
                                    reject(new Error('Failed to create image blob'));
                                }
                            }, 'image/png', 1.0);
                        });
                        
                        // Check blob size (Remove.bg has size limits)
                        if (blob.size > 10 * 1024 * 1024) { // 10MB limit
                            throw new Error('Image too large. Please use an image smaller than 10MB.');
                        }
                        
                        console.log(`Attempt ${retryCount + 1}: Sending image to Remove.bg API:`, {
                            size: blob.size,
                            type: blob.type,
                            dimensions: `${processingCanvas.width}x${processingCanvas.height}`
                        });
                        
                        // Prepare form data
                        const formData = new FormData();
                        formData.append('image_file', blob, 'logo.png');
                        formData.append('size', 'auto');
                        formData.append('format', 'png');
                        
                        // Add additional parameters for better results
                        formData.append('crop', 'false');
                        formData.append('scale', '100%');
                        
                        // Make API request with proper error handling and timeout
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 second timeout
                        
                        const response = await fetch('https://api.remove.bg/v1.0/removebg', {
                            method: 'POST',
                            headers: {
                                'X-Api-Key': REMOVE_BG_API_KEY
                            },
                            body: formData,
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        
                        console.log(`Attempt ${retryCount + 1}: API Response status:`, response.status);
                        
                        if (!response.ok) {
                            let errorMessage = `API Error: ${response.status}`;
                            
                            try {
                                const errorData = await response.json();
                                console.error(`Attempt ${retryCount + 1}: API Error details:`, errorData);
                                if (errorData.errors && errorData.errors.length > 0) {
                                    errorMessage = errorData.errors[0].message || errorMessage;
                                }
                            } catch (e) {
                                console.error('Failed to parse error response:', e);
                            }
                            
                            throw new Error(errorMessage);
                        }
                        
                        // Get the processed image
                        const resultBlob = await response.blob();
                        
                        if (resultBlob.size === 0) {
                            throw new Error('Received empty response from API');
                        }
                        
                        console.log(`Attempt ${retryCount + 1}: Received processed image:`, {
                            size: resultBlob.size,
                            type: resultBlob.type
                        });
                        
                        const imageUrl = URL.createObjectURL(resultBlob);
                        
                        // Update the logo with background removed version
                        appState.logoUrl = imageUrl;
                        appState.backgroundRemoved = true;
                        
                        // Load the processed image
                        const processedImg = new Image();
                        processedImg.onload = function() {
                            appState.originalImage = processedImg;
                            logoPreviewImg.src = imageUrl;
                            draw();
                            
                            showNotification('Success', 'Background removed successfully!', 'success');
                        };
                        
                        processedImg.onerror = function() {
                            throw new Error('Failed to load processed image');
                        };
                        
                        processedImg.src = imageUrl;
                        return true; // Success
                        
                    } catch (error) {
                        console.error(`Attempt ${retryCount + 1} failed:`, error);
                        
                        // If this is the last retry, throw the error
                        if (retryCount >= maxRetries) {
                            throw error;
                        }
                        
                        // If it's a temporary error (network, rate limit), retry
                        if (error.message.includes('429') || error.message.includes('network') || 
                            error.message.includes('fetch') || error.message.includes('timeout')) {
                            retryCount++;
                            console.log(`Retrying... (${retryCount}/${maxRetries})`);
                            
                            // Wait before retrying
                            await new Promise(resolve => setTimeout(resolve, 2000 * retryCount));
                            return await attemptBackgroundRemoval();
                        }
                        
                        // For other errors, don't retry
                        throw error;
                    }
                };
                
                try {
                    await attemptBackgroundRemoval();
                } catch (error) {
                    console.error('Background removal failed after all attempts:', error);
                    
                    let errorMessage = 'Failed to remove background';
                    
                    if (error.message.includes('401')) {
                        errorMessage = 'Invalid API key. Please check your Remove.bg API configuration.';
                    } else if (error.message.includes('413') || error.message.includes('too large')) {
                        errorMessage = 'Image is too large. Please use a smaller image (max 10MB).';
                    } else if (error.message.includes('400')) {
                        errorMessage = 'Invalid image format. Please use PNG, JPG, or WEBP with clear subject and background.';
                    } else if (error.message.includes('429')) {
                        errorMessage = 'Too many requests. Please wait a moment and try again.';
                    } else if (error.message.includes('network') || error.message.includes('fetch')) {
                        errorMessage = 'Network error. Please check your internet connection and try again.';
                    } else if (error.message.includes('too small')) {
                        errorMessage = 'Image resolution too low. Please use an image at least 100x100 pixels.';
                    } else if (errorMessage.includes('Empty') || errorMessage.includes('Invalid')) {
                        errorMessage = 'Could not detect subject in image. Try using an image with a clear subject against a solid background.';
                    } else if (error.message) {
                        errorMessage = error.message;
                    }
                    
                    showNotification('Error', errorMessage, 'error');
                } finally {
                    // Reset button state
                    appState.isProcessingBgRemoval = false;
                    this.disabled = false;
                    this.classList.remove('processing');
                    
                    if (appState.backgroundRemoved) {
                        this.innerHTML = '<i class="fas fa-undo"></i><span>Restore BG</span>';
                        this.title = 'Restore Original Background';
                    } else {
                        this.innerHTML = '<i class="fas fa-cut"></i><span>Remove BG</span>';
                        this.title = 'Remove Background';
                    }
                }
            });
            
            // Outline Toggle
            outlineToggle.addEventListener('change', function() {
                appState.outlineEnabled = this.checked;
                appState.hasOutline = this.checked;
                outlineControls.classList.toggle('hidden', !this.checked);
                
                draw();
                updateProgress();
                
                // Show notification
                const status = this.checked ? 'enabled' : 'disabled';
                showNotification('Outline Updated', `Outline has been ${status}`, 'info');
            });
            
            // Outline Width
            outlineWidth.addEventListener('input', function() {
                appState.outline.width = parseInt(this.value);
                outlineWidthValue.textContent = `${appState.outline.width}px`;
                draw();
            });
            
            // Outline Color
            outlineColorPicker.addEventListener('input', function() {
                const color = this.value;
                appState.outline.color = color;
                outlineColorHex.value = color;
                draw();
            });
            
            outlineColorHex.addEventListener('input', function() {
                let color = this.value;
                
                // Add # if missing
                if (!color.startsWith('#')) {
                    color = '#' + color;
                }
                
                // Validate hex color
                const hexColorRegex = /^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/;
                if (hexColorRegex.test(color)) {
                    appState.outline.color = color;
                    outlineColorPicker.value = color;
                    draw();
                }
            });
            
            // Smoothing Toggle
            smoothingToggle.addEventListener('change', function() {
                appState.outline.smoothing = this.checked;
                draw();
            });
            
            // Auto-optimize layout function with proper dependency handling
            function autoOptimizeLayout() {
                // Get current board size and sticker diameter
                const boardWidth = appState.boardSize.width;
                const boardHeight = appState.boardSize.height;
                const stickerDiameter = appState.stickerDiameter;
                
                console.log(`=== AUTO-OPTIMIZE LAYOUT ===`);
                console.log(`Board: ${boardWidth}×${boardHeight}cm, Sticker diameter: ${stickerDiameter}cm`);
                
                // Calculate how many stickers can fit horizontally and vertically
                const horizontalFit = Math.floor(boardWidth / stickerDiameter);
                const verticalFit = Math.floor(boardHeight / stickerDiameter);
                
                console.log(`Initial fit calculation: ${boardWidth}÷${stickerDiameter} = ${horizontalFit} horizontally`);
                console.log(`Initial fit calculation: ${boardHeight}÷${stickerDiameter} = ${verticalFit} vertically`);
                
                // Ensure minimum 1 sticker per dimension
                const minHorizontal = Math.max(1, horizontalFit);
                const minVertical = Math.max(1, verticalFit);
                
                // Cap at reasonable maximums for display purposes
                const maxHorizontal = Math.min(8, minHorizontal);
                const maxVertical = Math.min(8, minVertical);
                
                // If no stickers can fit (sticker too large), force minimum 1x1
                const finalHorizontal = horizontalFit === 0 ? 1 : maxHorizontal;
                const finalVertical = verticalFit === 0 ? 1 : maxVertical;
                
                console.log(`Final grid: ${finalHorizontal}×${finalVertical}`);
                console.log(`Total stickers: ${finalHorizontal * finalVertical}`);
                console.log(`============================`);
                
                // Always update grid to ensure consistency
                const gridChanged = appState.grid.horizontal !== finalHorizontal || appState.grid.vertical !== finalVertical;
                
                appState.grid.horizontal = finalHorizontal;
                appState.grid.vertical = finalVertical;
                
                console.log(`Grid updated: ${finalHorizontal}×${finalVertical} (changed: ${gridChanged})`);
                
                // Force canvas size update and redraw
                updateCanvasSizeForOriginalResolution();
                
                // Update displays
                updateSpaceUsed();
                
                // Force complete redraw
                draw();
                
                // Show notification with actual numbers
                const totalStickers = finalHorizontal * finalVertical;
                const message = `Grid: ${finalHorizontal}×${finalVertical} (${totalStickers} stickers)`;
                showNotification('Layout Updated', message, 'success');
                
                // Mark layout as configured
                appState.hasLayout = true;
                updateProgress();
            }
            
            // Test function to verify dependency calculation
            function testLayoutCalculation() {
                console.log('=== LAYOUT TEST ===');
                const testCases = [
                    { board: '10x15', diameter: 5 },
                    { board: '15x20', diameter: 5 },
                    { board: '20x30', diameter: 5 },
                    { board: '15x20', diameter: 10 },
                    { board: '15x20', diameter: 3 }
                ];
                
                testCases.forEach(testCase => {
                    const [boardW, boardH] = testCase.board.split('x').map(Number);
                    const horizontalFit = Math.floor(boardW / testCase.diameter);
                    const verticalFit = Math.floor(boardH / testCase.diameter);
                    console.log(`Board ${testCase.board}cm, Sticker ${testCase.diameter}cm → ${horizontalFit}×${verticalFit} grid`);
                });
                console.log('==================');
            }
            
            // Size Controls
            boardSizeSelect.addEventListener('change', function() {
                const selectedSize = this.value;
                appState.boardSize = boardSizeOptions[selectedSize];
                console.log(`Board size changed to ${selectedSize} (${appState.boardSize.width}×${appState.boardSize.height}cm)`);
                updateSizeDisplay();
                updateSpaceUsed();
                autoOptimizeLayout(); // Automatically optimize layout for new board size
            });
            
            diameterDecrease.addEventListener('click', function() {
                const currentValue = parseFloat(diameterInput.value);
                if (currentValue > 1) {
                    const newValue = Math.max(1, currentValue - 0.5);
                    diameterInput.value = newValue;
                    appState.stickerDiameter = newValue;
                    console.log(`Diameter decreased to ${newValue}cm`);
                    updateSizeDisplay();
                    updateSpaceUsed();
                    autoOptimizeLayout(); // Automatically optimize layout for new diameter
                }
            });
            
            diameterIncrease.addEventListener('click', function() {
                const currentValue = parseFloat(diameterInput.value);
                if (currentValue < 20) {
                    const newValue = Math.min(20, currentValue + 0.5);
                    diameterInput.value = newValue;
                    appState.stickerDiameter = newValue;
                    console.log(`Diameter increased to ${newValue}cm`);
                    updateSizeDisplay();
                    updateSpaceUsed();
                    autoOptimizeLayout(); // Automatically optimize layout for new diameter
                }
            });
            
            // Debounced diameter input to prevent excessive redraws
            let diameterInputTimeout;
            diameterInput.addEventListener('input', function() {
                clearTimeout(diameterInputTimeout);
                diameterInputTimeout = setTimeout(() => {
                    let value = parseFloat(this.value);
                    if (isNaN(value)) value = 1;
                    value = Math.max(1, Math.min(20, value));
                    this.value = value;
                    if (appState.stickerDiameter !== value) {
                        appState.stickerDiameter = value;
                        console.log(`Diameter input changed to ${value}cm`);
                        updateSizeDisplay();
                        updateSpaceUsed();
                        autoOptimizeLayout(); // Automatically optimize layout for new diameter
                    }
                }, 300); // 300ms debounce
            });
            
            // Action Buttons
            resetBtn.addEventListener('click', function() {
                // Reset to default values
                appState.logoUrl = defaultLogo;
                appState.originalImage = null;
                appState.boardSize = { width: 15, height: 20 };
                appState.stickerDiameter = 5;
                appState.outlineEnabled = true;
                appState.outline.width = 6;
                appState.outline.color = '#000000';
                appState.outline.smoothing = true;
                appState.grid.horizontal = 2;
                appState.grid.vertical = 2;
                appState.hasLogo = false;
                appState.hasOutline = true;
                appState.hasLayout = false;
                
                // Update UI
                outlineWidth.value = appState.outline.width;
                outlineWidthValue.textContent = `${appState.outline.width}px`;
                outlineToggle.checked = appState.outlineEnabled;
                outlineColorPicker.value = appState.outline.color;
                outlineColorHex.value = appState.outline.color;
                smoothingToggle.checked = appState.outline.smoothing;
                boardSizeSelect.value = '15x20';
                diameterInput.value = appState.stickerDiameter;
                
                // Reset logo
                logoPreviewImg.src = defaultLogo;
                logoPreviewName.textContent = 'Default Logo';
                appState.backgroundRemoved = false;
                appState.isProcessingBgRemoval = false;
                
                // Reset button state
                logoRemoveBgBtn.disabled = false;
                logoRemoveBgBtn.classList.remove('processing');
                logoRemoveBgBtn.innerHTML = '<i class="fas fa-cut"></i><span>Remove BG</span>';
                logoRemoveBgBtn.title = 'Remove Background';
                
                // Load default logo
                loadDefaultLogo();
                
                // Update displays
                updateSizeDisplay();
                updateSpaceUsed();
                updateProgress();
                draw(); // Redraw
                
                // Show notification
                showNotification('Settings Reset', 'All settings have been reset to default', 'info');
            });
            
            // Download button - generate sticker sheet
            downloadBtn.addEventListener('click', function() {
                generateStickerSheet();
            });
            
            confirmYesBtn.addEventListener('click', function() {
                // Hide other messages
                helpMessage.style.display = 'none';
                
                // Show success message
                successMessage.style.display = 'block';
                
                // In a real Shopify implementation, this would add the item to cart
                console.log('Sticker design confirmed with configuration:', appState);
                
                // Show notification
                showNotification('Order Confirmed', 'Your design has been added to cart', 'success');
                
                // Scroll to confirmation message
                successMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            });
            
            confirmHelpBtn.addEventListener('click', function() {
                // Hide other messages
                successMessage.style.display = 'none';
                
                // Show help message
                helpMessage.style.display = 'block';
                
                // In a real implementation, this would trigger a support request
                console.log('Help requested for sticker design');
                
                // Show notification
                showNotification('Support Requested', 'Our team will contact you shortly', 'info');
                
                // Scroll to confirmation message
                helpMessage.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                
                // Hide message after 5 seconds
                setTimeout(() => {
                    helpMessage.style.display = 'none';
                }, 5000);
            });
            
            // Close notification
            notificationClose.addEventListener('click', function() {
                notificationToast.classList.remove('show');
            });
            
            // Calculate space used percentage
            function calculateSpaceUsed() {
                const boardArea = appState.boardSize.width * appState.boardSize.height;
                const stickerArea = Math.PI * Math.pow(appState.stickerDiameter / 2, 2);
                const totalStickerArea = stickerArea * appState.grid.horizontal * appState.grid.vertical;
                
                return Math.min(100, Math.round((totalStickerArea / boardArea) * 100));
            }
            
            // Update space used display
            function updateSpaceUsed() {
                const spaceUsed = calculateSpaceUsed();
                spaceUsedValue.textContent = `${spaceUsed}%`;
                totalStickersValue.textContent = appState.grid.horizontal * appState.grid.vertical;
                
                // Update color based on usage
                if (spaceUsed < 50) {
                    spaceUsedValue.style.color = '#ef4444';
                } else if (spaceUsed < 80) {
                    spaceUsedValue.style.color = '#f59e0b';
                } else {
                    spaceUsedValue.style.color = '#10b981';
                }
            }
            
            // Update Size Display
            function updateSizeDisplay() {
                // Update board label
                boardLabel.textContent = `Board ${appState.boardSize.width} × ${appState.boardSize.height} cm`;
                boardSizeValue.textContent = `${appState.boardSize.width} × ${appState.boardSize.height} cm`;
                
                // Update sticker diameter
                stickerDiameterValue.textContent = `${appState.stickerDiameter} cm`;
                
                // Update button states
                diameterDecrease.disabled = appState.stickerDiameter <= 1;
                diameterIncrease.disabled = appState.stickerDiameter >= 20;
            }
            
            // Grid display function-optimization instead
            // Layout is size or diameter changes
            // No manual grid controls needed with the new auto automatically optimized when board removed - using auto-fit system
            
            // Dynamic canvas sizing based on grid layout
            function updateCanvasSize() {
                const cols = appState.grid.horizontal;
                const rows = appState.grid.vertical;
                
                // Base sticker size (will be adjusted for readability)
                const baseStickerSize = 60; // pixels
                const gap = 15; // pixels between stickers
                const padding = 30; // padding around the grid
                
                // Calculate total dimensions
                const totalWidth = cols * baseStickerSize + (cols - 1) * gap + padding * 2;
                const totalHeight = rows * baseStickerSize + (rows - 1) * gap + padding * 2;
                
                // Set canvas size
                canvas.width = totalWidth;
                canvas.height = totalHeight;
                
                // Update container sizes to fit content
                previewBoard.style.width = totalWidth + 'px';
                previewBoard.style.height = totalHeight + 'px';
                canvasContainer.style.width = totalWidth + 'px';
                canvasContainer.style.height = totalHeight + 'px';
                
                // Add smooth transition
                previewBoard.style.transition = 'width 0.3s ease, height 0.3s ease';
                canvasContainer.style.transition = 'width 0.3s ease, height 0.3s ease';
            }
            
            // Main draw function with original resolution support
            function draw() {
                if (!appState.originalImage) return;
                
                // Update canvas size based on grid with original resolution support
                updateCanvasSizeForOriginalResolution();
                
                const width = canvas.width;
                const height = canvas.height;
                
                // Clear canvas
                ctx.clearRect(0, 0, width, height);
                
                // Draw a subtle grid background for the board
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, width, height);
                
                const outlineWidth = appState.outlineEnabled ? appState.outline.width : 0;
                const outlineColor = appState.outline.color;
                const smooth = appState.outline.smoothing;
                
                // Calculate grid layout
                const cols = appState.grid.horizontal;
                const rows = appState.grid.vertical;
                
                // Use calculated sizes for auto-resize functionality
                const padding = appState.calculatedPadding || 30;
                const gap = appState.calculatedGap || 15;
                const stickerSize = appState.calculatedStickerSize || 120;
                
                // Calculate available space
                const availableWidth = width - (padding * 2);
                const availableHeight = height - (padding * 2);
                
                // Calculate starting position to center the grid
                const totalWidth = cols * stickerSize + (cols - 1) * gap;
                const totalHeight = rows * stickerSize + (rows - 1) * gap;
                const startX = (width - totalWidth) / 2;
                const startY = (height - totalHeight) / 2;
                
                // Draw each sticker in the grid with original resolution support
                for (let row = 0; row < rows; row++) {
                    for (let col = 0; col < cols; col++) {
                        const stickerX = startX + col * (stickerSize + gap);
                        const stickerY = startY + row * (stickerSize + gap);
                        const centerX = stickerX + stickerSize / 2;
                        const centerY = stickerY + stickerSize / 2;
                        
                        // Create a temporary canvas for this sticker
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = stickerSize;
                        tempCanvas.height = stickerSize;
                        const tempCtx = tempCanvas.getContext('2d');
                        
                        // Clear temp canvas
                        tempCtx.clearRect(0, 0, stickerSize, stickerSize);
                        
                        // Save context state for clipping
                        ctx.save();
                        
                        // Create clipping path to keep sticker within bounds
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, stickerSize / 2, 0, 2 * Math.PI);
                        ctx.clip();
                        
                        // Draw sticker background circle
                        ctx.beginPath();
                        ctx.arc(centerX, centerY, stickerSize / 2, 0, 2 * Math.PI);
                        ctx.fillStyle = '#ffffff';
                        ctx.fill();
                        
                        // Add subtle shadow
                        ctx.shadowColor = 'rgba(0, 0, 0, 0.1)';
                        ctx.shadowBlur = 4;
                        ctx.shadowOffsetX = 2;
                        ctx.shadowOffsetY = 2;
                        
                        // Calculate image size with ORIGINAL RESOLUTION SUPPORT
                        const imgW = appState.originalImage.width;
                        const imgH = appState.originalImage.height;
                        
                        // For original resolution, use the full image size or scale to fit sticker
                        const maxImgSize = stickerSize * 0.8; // Use 80% of sticker size for original resolution
                        const imgScale = Math.min(maxImgSize / imgW, maxImgSize / imgH);
                        
                        // Use original resolution dimensions for the final display
                        const drawW = imgW * imgScale;
                        const drawH = imgH * imgScale;
                        const imgX = centerX - drawW / 2;
                        const imgY = centerY - drawH / 2;
                        
                        // Draw image on temp canvas at original resolution
                        tempCtx.drawImage(appState.originalImage, imgX - stickerX, imgY - stickerY, drawW, drawH);
                        
                        if (outlineWidth > 0) {
                            // Generate Outline using distance transform algorithm for this sticker
                            const imageData = tempCtx.getImageData(0, 0, stickerSize, stickerSize);
                            const data = imageData.data;
                            
                            // Create a mask: 0 for empty, 1 for object
                            const distMap = new Float32Array(stickerSize * stickerSize);
                            const INF = 1e9;
                            
                            // Initialize Distance Map
                            for (let i = 0; i < stickerSize * stickerSize; i++) {
                                // Check alpha channel (every 4th byte)
                                if (data[i * 4 + 3] > 10) { // Threshold for "opaque"
                                    distMap[i] = 0;
                                } else {
                                    distMap[i] = INF;
                                }
                            }
                            
                            // Fast Euclidean Distance Transform (EDT) - Two-pass algorithm
                            // Pass 1: Top-Left to Bottom-Right
                            for (let y = 0; y < stickerSize; y++) {
                                for (let x = 0; x < stickerSize; x++) {
                                    const idx = y * stickerSize + x;
                                    if (distMap[idx] === 0) continue;
                                    
                                    let min = distMap[idx];
                                    // Check neighbors: Left, Top-Left, Top, Top-Right
                                    if (x > 0) min = Math.min(min, distMap[idx - 1] + 1); // Left
                                    if (y > 0) {
                                        min = Math.min(min, distMap[idx - stickerSize] + 1); // Top
                                        if (x > 0) min = Math.min(min, distMap[idx - stickerSize - 1] + 1.414); // Top-Left
                                        if (x < stickerSize - 1) min = Math.min(min, distMap[idx - stickerSize + 1] + 1.414); // Top-Right
                                    }
                                    distMap[idx] = min;
                                }
                            }
                            
                            // Pass 2: Bottom-Right to Top-Left
                            for (let y = stickerSize - 1; y >= 0; y--) {
                                for (let x = stickerSize - 1; x >= 0; x--) {
                                    const idx = y * stickerSize + x;
                                    if (distMap[idx] === 0) continue;
                                    
                                    let min = distMap[idx];
                                    // Check neighbors: Right, Bottom-Right, Bottom, Bottom-Left
                                    if (x < stickerSize - 1) min = Math.min(min, distMap[idx + 1] + 1); // Right
                                    if (y < stickerSize - 1) {
                                        min = Math.min(min, distMap[idx + stickerSize] + 1); // Bottom
                                        if (x < stickerSize - 1) min = Math.min(min, distMap[idx + stickerSize + 1] + 1.414); // Bottom-Right
                                        if (x > 0) min = Math.min(min, distMap[idx + stickerSize - 1] + 1.414); // Bottom-Left
                                    }
                                    distMap[idx] = min;
                                }
                            }
                            
                            // Draw the outline based on distance
                            const [r, g, b] = hexToRgb(outlineColor);
                            const resultData = ctx.createImageData(stickerSize, stickerSize);
                            const res = resultData.data;
                            
                            for (let i = 0; i < stickerSize * stickerSize; i++) {
                                const dist = distMap[i];
                                if (dist <= outlineWidth) {
                                    // Inside the outline zone
                                    let alpha = 255;
                                    if (smooth && dist > outlineWidth - 1) {
                                        // Fade out at the edge
                                        alpha = 255 * (1 - (dist - (outlineWidth - 1)));
                                    }
                                    
                                    res[i * 4] = r;
                                    res[i * 4 + 1] = g;
                                    res[i * 4 + 2] = b;
                                    res[i * 4 + 3] = alpha;
                                }
                            }
                            
                            // Put the outline on the main canvas
                            ctx.putImageData(resultData, stickerX, stickerY);
                        }
                        
                        // Reset shadow and draw the image on top at original resolution
                        ctx.shadowColor = 'transparent';
                        ctx.drawImage(appState.originalImage, imgX, imgY, drawW, drawH);
                        
                        // Restore context state (removes clipping)
                        ctx.restore();
                        
                        // Circle border removed - stickers now have clean edges
                    }
                }
                
                // Update the total stickers display
                totalStickersValue.textContent = cols * rows;
            }
            
            // Canvas sizing function with proper grid dependency
            function updateCanvasSizeForOriginalResolution() {
                const cols = appState.grid.horizontal;
                const rows = appState.grid.vertical;
                
                console.log(`Canvas sizing for grid: ${cols}×${rows}`);
                
                // Check if mobile device
                const isMobile = window.innerWidth <= 767;
                
                // Get board dimensions in cm
                const boardWidthCm = appState.boardSize.width;
                const boardHeightCm = appState.boardSize.height;
                const stickerDiameterCm = appState.stickerDiameter;
                
                console.log(`Board: ${boardWidthCm}×${boardHeightCm}cm, Sticker: ${stickerDiameterCm}cm`);
                
                // Calculate actual sticker size based on board proportions
                // This ensures stickers scale properly with board size and sticker diameter
                const boardArea = boardWidthCm * boardHeightCm;
                const stickerArea = Math.PI * Math.pow(stickerDiameterCm / 2, 2);
                const totalStickerArea = stickerArea * cols * rows;
                const areaRatio = totalStickerArea / boardArea;
                
                // Mobile constraints
                const maxMobileCanvasSize = isMobile ? 320 : 400;
                const maxDesktopCanvasSize = 600;
                const maxCanvasSize = isMobile ? maxMobileCanvasSize : maxDesktopCanvasSize;
                
                // Calculate optimal sticker size based on grid density
                const gap = isMobile ? 8 : 10;
                const padding = isMobile ? 15 : 20;
                
                // Calculate sticker size to fit grid while maintaining proportions
                const availableWidth = maxCanvasSize - (cols - 1) * gap - padding * 2;
                const availableHeight = (isMobile ? 280 : 500) - (rows - 1) * gap - padding * 2;
                
                const maxStickerWidth = availableWidth / cols;
                const maxStickerHeight = availableHeight / rows;
                
                // Use the smaller dimension but ensure minimum size
                const baseStickerSize = Math.max(30, Math.floor(Math.min(maxStickerWidth, maxStickerHeight)));
                
                console.log(`Calculated sticker size: ${baseStickerSize}px for grid ${cols}×${rows}`);
                
                // Calculate total canvas dimensions
                const totalWidth = cols * baseStickerSize + (cols - 1) * gap + padding * 2;
                const totalHeight = rows * baseStickerSize + (rows - 1) * gap + padding * 2;
                
                // Ensure canvas doesn't exceed maximum limits
                const safeWidth = Math.min(totalWidth, maxCanvasSize);
                const safeHeight = Math.min(totalHeight, isMobile ? 280 : 500);
                
                console.log(`Final canvas size: ${safeWidth}×${safeHeight}px`);
                
                // Store the calculated size for use in drawing
                appState.calculatedStickerSize = baseStickerSize;
                appState.calculatedGap = gap;
                appState.calculatedPadding = padding;
                
                // Set canvas size
                canvas.width = safeWidth;
                canvas.height = safeHeight;
                
                // Update container sizes
                previewBoard.style.width = safeWidth + 'px';
                previewBoard.style.height = safeHeight + 'px';
                canvasContainer.style.width = safeWidth + 'px';
                canvasContainer.style.height = safeHeight + 'px';
                
                // Add smooth transition
                previewBoard.style.transition = 'width 0.3s ease, height 0.3s ease';
                canvasContainer.style.transition = 'width 0.3s ease, height 0.3s ease';
            }
            
            // Generate sticker sheet for download with optimized resolution
            function generateStickerSheet() {
                try {
                    // Disable button during generation to prevent multiple clicks
                    downloadBtn.disabled = true;
                    downloadBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i><span>Generating...</span>';
                    
                    showNotification('Generating Sticker Sheet', 'Creating high-quality sticker sheet...', 'info');
                    
                    // Use setTimeout to allow UI to update before heavy processing
                    setTimeout(() => {
                        try {
                            // Create optimized canvas with reasonable resolution limits
                            const sheetCanvas = document.createElement('canvas');
                            const sheetCtx = sheetCanvas.getContext('2d');
                            
                            // Get grid dimensions
                            const cols = appState.grid.horizontal;
                            const rows = appState.grid.vertical;
                            const outlineWidth = appState.outlineEnabled ? appState.outline.width : 0;
                            const outlineColor = appState.outline.color;
                            const smooth = appState.outline.smoothing;
                            
                            // Calculate reasonable base sticker size (2x scale for quality without memory issues)
                            const baseStickerSize = Math.min(300, (appState.calculatedStickerSize || 120) * 2);
                            const gap = (appState.calculatedGap || 15) * 2;
                            const padding = (appState.calculatedPadding || 30) * 2;
                            
                            // Calculate total dimensions with hard limits to prevent memory issues
                            const maxTotalSize = 4000; // Max 4000px to prevent memory exhaustion
                            
                            let totalWidth = cols * baseStickerSize + (cols - 1) * gap + padding * 2;
                            let totalHeight = rows * baseStickerSize + (rows - 1) * gap + padding * 2;
                            
                            // Scale down if too large
                            const scaleFactor = Math.min(1, maxTotalSize / Math.max(totalWidth, totalHeight));
                            if (scaleFactor < 1) {
                                totalWidth = Math.floor(totalWidth * scaleFactor);
                                totalHeight = Math.floor(totalHeight * scaleFactor);
                            }
                            
                            // Set canvas size
                            sheetCanvas.width = totalWidth;
                            sheetCanvas.height = totalHeight;
                            
                            // Set high-quality scaling
                            sheetCtx.imageSmoothingEnabled = true;
                            sheetCtx.imageSmoothingQuality = 'high';
                            
                            // Calculate sticker size based on available space
                            const availableWidth = totalWidth - (padding * 2);
                            const availableHeight = totalHeight - (padding * 2);
                            const stickerSize = Math.min(
                                (availableWidth - (cols - 1) * gap) / cols,
                                (availableHeight - (rows - 1) * gap) / rows
                            );
                            
                            // Scale factor for outline width
                            const outlineScale = stickerSize / (appState.calculatedStickerSize || 120);
                            const scaledOutlineWidth = outlineWidth * outlineScale;
                            
                            // Calculate starting position to center the grid
                            const startX = (totalWidth - (cols * stickerSize + (cols - 1) * gap)) / 2;
                            const startY = (totalHeight - (rows * stickerSize + (rows - 1) * gap)) / 2;
                            
                            // Draw each sticker in the grid
                            for (let row = 0; row < rows; row++) {
                                for (let col = 0; col < cols; col++) {
                                    const stickerX = startX + col * (stickerSize + gap);
                                    const stickerY = startY + row * (stickerSize + gap);
                                    const centerX = stickerX + stickerSize / 2;
                                    const centerY = stickerY + stickerSize / 2;
                                    
                                    // Create temporary canvas for this sticker
                                    const tempCanvas = document.createElement('canvas');
                                    tempCanvas.width = stickerSize;
                                    tempCanvas.height = stickerSize;
                                    const tempCtx = tempCanvas.getContext('2d');
                                    
                                    // Clear temp canvas (transparent)
                                    tempCtx.clearRect(0, 0, stickerSize, stickerSize);
                                    
                                    // Draw image on temp canvas first
                                    const imgW = appState.originalImage.width;
                                    const imgH = appState.originalImage.height;
                                    const maxImgSize = stickerSize * 0.8;
                                    const imgScale = Math.min(maxImgSize / imgW, maxImgSize / imgH);
                                    const drawW = imgW * imgScale;
                                    const drawH = imgH * imgScale;
                                    const imgX = centerX - drawW / 2;
                                    const imgY = centerY - drawH / 2;
                                    tempCtx.drawImage(appState.originalImage, imgX - stickerX, imgY - stickerY, drawW, drawH);
                                    
                                    // Get image data for outline generation
                                    const imageData = tempCtx.getImageData(0, 0, stickerSize, stickerSize);
                                    const data = imageData.data;
                                    
                                    // Create outline using distance transform
                                    const distMap = new Float32Array(stickerSize * stickerSize);
                                    const INF = 1e9;
                                    
                                    // Initialize distance map
                                    for (let i = 0; i < stickerSize * stickerSize; i++) {
                                        if (data[i * 4 + 3] > 10) {
                                            distMap[i] = 0;
                                        } else {
                                            distMap[i] = INF;
                                        }
                                    }
                                    
                                    // Two-pass distance transform
                                    for (let y = 0; y < stickerSize; y++) {
                                        for (let x = 0; x < stickerSize; x++) {
                                            const idx = y * stickerSize + x;
                                            if (distMap[idx] === 0) continue;
                                            let min = distMap[idx];
                                            if (x > 0) min = Math.min(min, distMap[idx - 1] + 1);
                                            if (y > 0) {
                                                min = Math.min(min, distMap[idx - stickerSize] + 1);
                                                if (x > 0) min = Math.min(min, distMap[idx - stickerSize - 1] + 1.414);
                                                if (x < stickerSize - 1) min = Math.min(min, distMap[idx - stickerSize + 1] + 1.414);
                                            }
                                            distMap[idx] = min;
                                        }
                                    }
                                    
                                    for (let y = stickerSize - 1; y >= 0; y--) {
                                        for (let x = stickerSize - 1; x >= 0; x--) {
                                            const idx = y * stickerSize + x;
                                            if (distMap[idx] === 0) continue;
                                            let min = distMap[idx];
                                            if (x < stickerSize - 1) min = Math.min(min, distMap[idx + 1] + 1);
                                            if (y < stickerSize - 1) {
                                                min = Math.min(min, distMap[idx + stickerSize] + 1);
                                                if (x < stickerSize - 1) min = Math.min(min, distMap[idx + stickerSize + 1] + 1.414);
                                                if (x > 0) min = Math.min(min, distMap[idx + stickerSize - 1] + 1.414);
                                            }
                                            distMap[idx] = min;
                                        }
                                    }
                                    
                                    // Save context state for clipping
                                    sheetCtx.save();
                                    
                                    // Create clipping path for sticker circle
                                    sheetCtx.beginPath();
                                    sheetCtx.arc(centerX, centerY, stickerSize / 2, 0, 2 * Math.PI);
                                    sheetCtx.clip();
                                    
                                    // Draw white background
                                    sheetCtx.beginPath();
                                    sheetCtx.arc(centerX, centerY, stickerSize / 2, 0, 2 * Math.PI);
                                    sheetCtx.fillStyle = '#ffffff';
                                    sheetCtx.fill();
                                    
                                    // Draw outline based on distance
                                    if (outlineWidth > 0) {
                                        const [r, g, b] = hexToRgb(outlineColor);
                                        const resultData = sheetCtx.createImageData(stickerSize, stickerSize);
                                        const res = resultData.data;
                                        
                                        for (let i = 0; i < stickerSize * stickerSize; i++) {
                                            const dist = distMap[i];
                                            if (dist <= scaledOutlineWidth) {
                                                let alpha = 255;
                                                if (smooth && dist > scaledOutlineWidth - 1) {
                                                    alpha = 255 * (1 - (dist - (scaledOutlineWidth - 1)));
                                                }
                                                res[i * 4] = r;
                                                res[i * 4 + 1] = g;
                                                res[i * 4 + 2] = b;
                                                res[i * 4 + 3] = alpha;
                                            }
                                        }
                                        
                                        sheetCtx.putImageData(resultData, stickerX, stickerY);
                                    }
                                    
                                    // Draw the image on top
                                    sheetCtx.shadowColor = 'transparent';
                                    sheetCtx.drawImage(appState.originalImage, imgX, imgY, drawW, drawH);
                                    
                                    // Restore context state (removes clipping)
                                    sheetCtx.restore();
                                    
                                    // Draw outer circle border for clean edges
                                    sheetCtx.beginPath();
                                    sheetCtx.arc(centerX, centerY, stickerSize / 2, 0, 2 * Math.PI);
                                    sheetCtx.strokeStyle = 'rgba(0, 0, 0, 0.1)';
                                    sheetCtx.lineWidth = 1;
                                    sheetCtx.stroke();
                                }
                            }
                            
                            // Convert canvas to blob and download
                            sheetCanvas.toBlob(function(blob) {
                                if (!blob) {
                                    throw new Error('Failed to generate image');
                                }
                                
                                const url = URL.createObjectURL(blob);
                                const a = document.createElement('a');
                                a.href = url;
                                a.download = `sticker-sheet-${appState.boardSize.width}x${appState.boardSize.height}cm-${cols}x${rows}.png`;
                                document.body.appendChild(a);
                                a.click();
                                document.body.removeChild(a);
                                URL.revokeObjectURL(url);
                                
                                setTimeout(() => {
                                    showNotification('Download Complete', 'Your sticker sheet has been downloaded', 'success');
                                }, 500);
                            }, 'image/png', 1.0);
                            
                        } catch (innerError) {
                            console.error('Sticker generation error:', innerError);
                            showNotification('Download Failed', 'There was an error generating your sticker sheet', 'error');
                        } finally {
                            // Re-enable button
                            downloadBtn.disabled = false;
                            downloadBtn.innerHTML = '<i class="fas fa-download"></i><span>Download</span>';
                        }
                    }, 100); // Small delay to allow UI update
                    
                } catch (error) {
                    console.error('Download error:', error);
                    showNotification('Download Failed', 'There was an error generating your sticker sheet', 'error');
                    // Re-enable button in case of error
                    downloadBtn.disabled = false;
                    downloadBtn.innerHTML = '<i class="fas fa-download"></i><span>Download</span>';
                }
            }
            
            // Convert hex color to RGB
            function hexToRgb(hex) {
                const bigint = parseInt(hex.slice(1), 16);
                const r = (bigint >> 16) & 255;
                const g = (bigint >> 8) & 255;
                const b = bigint & 255;
                return [r, g, b];
            }
            
            // Handle window resize
            window.addEventListener('resize', function() {
                // Debounce resize events
                clearTimeout(window.resizeTimer);
                window.resizeTimer = setTimeout(function() {
                    // Adjust canvas size if needed
                    draw();
                }, 250);
            });
            
            // Initialize the app
            initApp();
        });
    </script>
</body>
</html>